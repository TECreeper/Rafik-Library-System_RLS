@page "/borrow"
@using Library_website.Components.Layout
@using MyLibraryApp.Models
@using MyLibraryApp.Data
@inject BookService BookService
@inject MemberService MemberService
@rendermode InteractiveServer
@layout EmptyLayout
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="dashboard-container">

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fa-solid fa-chart-simple"></i> Library Admin</h3>
        </div>

        <nav class="sidebar-nav">
            <p class="nav-label">Navigation</p>
            <a href="/" class="nav-item"><i class="fa-solid fa-table-columns"></i> Dashboard</a>
            <a href="/books" class="nav-item"><i class="fa-solid fa-book"></i> Books</a>
            <a href="/members" class="nav-item"><i class="fa-solid fa-users"></i> Members</a>
            <a href="#" class="nav-item active"><i class="fa-solid fa-arrow-right-arrow-left"></i> Borrow & Returns</a>
            <p class="nav-label">Alerts</p>
            <a href="/overdue" class="nav-item alert-link">
                <i class="fa-solid fa-circle-exclamation"></i> Overdues
            </a>
        </nav>
    </aside>

    <main class="main-content">

        <header class="top-bar">
            <div class="breadcrumbs">
                <h2>Circulation Desk</h2>
                <span>Home > Borrow & Returns</span>
            </div>
            @* <button class="btn btn-outline" title="Overdue Alerts">
                <i class="fa-regular fa-bell"></i>
                <span class="badge-dot"></span>
            </button> *@
        </header>

        <div class="card action-card">
            <div class="tabs-header">
                <button type="button"
                        class="tab-btn @(ActiveTab == "Issue" ? "active" : "")"
                        @onclick='() => SetTab("Issue")'>
                    <i class="fa-solid fa-book-open"></i> Issue Book
                </button>

                <button type="button"
                        class="tab-btn @(ActiveTab == "Return" ? "active" : "")"
                        @onclick='() => SetTab("Return")'>
                    <i class="fa-solid fa-rotate-left"></i> Return Book
                </button>
            </div>

            <div class="tab-content">

                @if (!string.IsNullOrEmpty(Message))
                {
                    <div style="padding: 10px; margin-bottom: 15px; border-radius: 8px; background-color: @(IsError ? "#f8d7da" : "#d4edda"); color: @(IsError ? "#721c24" : "#155724");">
                        @Message
                    </div>
                }

                @if (ActiveTab == "Issue")
                {
                    <div class="form-grid">
                        <div class="input-group">
                            <label>Member ID / Name</label>
                            <div class="input-wrapper">
                                <i class="fa-solid fa-user"></i>
                                <input type="text" placeholder="Search member ID or Name..." @bind="issueMemberInput" />
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Book ID / Title / ID</label>
                            <div class="input-wrapper">
                                <i class="fa-solid fa-book"></i>
                                <input type="text" placeholder="Scan or type book..." @bind="issueBookInput" />
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Due Date</label>
                            <input type="date" class="date-input" @bind="issueDueDate" />
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary big-btn" @onclick="ExecuteIssue">Confirm Issue <i class="fa-solid fa-check"></i></button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="form-grid return-mode">
                        <div class="input-group full-width">
                            <label>Book ID / ID to Return</label>
                            <div class="input-wrapper">
                                <i class="fa-solid fa-barcode"></i>
                                <input type="text" placeholder="Scan book ID or ID..." @bind="returnBookInput" />
                            </div>
                        </div>
                        <div class="fine-box">
                            <span><i class="fa-solid fa-circle-info"></i> No fines pending for this item.</span>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-success big-btn" @onclick="ExecuteReturn">Confirm Return <i class="fa-solid fa-check"></i></button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <h3 class="section-title">Recent Transactions</h3>

        <div class="card table-card">
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Trans ID</th>
                        <th>Book Title</th>
                        <th>Member ID</th>
                        <th>Issued Date</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Transactions)
                    {
                        <tr>
                            <td class="trans-id">#@item.Id</td>
                            <td><span class="book-title">@item.Title</span></td>
                            <td>
                                <div class="member-mini">
                                    <div style="width:24px;height:24px;border-radius:50%;background:#ddd;text-align:center;line-height:24px;margin-right:8px;">
                                        @item.CurrentMemberId
                                    </div>
                                    Member #@item.CurrentMemberId
                                </div>
                            </td>
                            <td class="date">@(item.BorrowDate?.ToString("MMM dd") ?? "-")</td>
                            <td class="date">@(item.DueDate?.ToString("MMM dd") ?? "-")</td>
                            <td>
                                @if (item.IsBorrowed)
                                {
                                    <span class="status-badge blue">Borrowed</span>
                                }
                                else
                                {
                                    <span class="status-badge green">Returned</span>
                                }
                            </td>
                            <td>
                                @if (item.IsBorrowed)
                                {
                                    <button class="icon-btn" title="Quick Return" @onclick="() => QuickReturn(item.Id)">
                                        <i class="fa-solid fa-rotate-left"></i>
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    </main>
</div>

@code {
    // --- State Variables ---
    public string ActiveTab = "Issue";
    public string Message = "";
    public bool IsError = false;

    // --- Inputs ---
    private string issueMemberInput = "";
    private string issueBookInput = "";
    private DateTime issueDueDate = DateTime.Now.AddDays(14); // Default 2 weeks
    private string returnBookInput = "";

    // --- Data List ---
    private List<Book> Transactions = new List<Book>();

    // --- Lifecycle ---
    protected override async Task OnInitializedAsync()
    {
        await LoadTransactions();
    }

    private async Task LoadTransactions()
    {
        // Load books that are currently borrowed (or were recently)
        var allBooks = await BookService.GetBooksAsync();
        Transactions = allBooks.Where(b => b.IsBorrowed).OrderByDescending(b => b.BorrowDate).ToList();
    }

    // --- Actions ---

    private void SetTab(string tabName)
    {
        ActiveTab = tabName;
        Message = ""; // Clear messages on tab switch
    }

    private async Task ExecuteIssue()
    {
        if (string.IsNullOrWhiteSpace(issueBookInput) || string.IsNullOrWhiteSpace(issueMemberInput))
        {
            ShowMessage("Please fill in both Member and Book fields.", true);
            return;
        }

        // Call the updated Service method
        string result = await BookService.CheckoutBookAsync(issueBookInput, issueMemberInput, issueDueDate);

        if (result == "Success")
        {
            ShowMessage("Book issued successfully!", false);
            issueBookInput = "";
            issueMemberInput = "";
            await LoadTransactions();
        }
        else
        {
            ShowMessage(result, true);
        }
    }

    private async Task ExecuteReturn()
    {
        if (string.IsNullOrWhiteSpace(returnBookInput))
        {
            ShowMessage("Please enter a Book ID or Title.", true);
            return;
        }

        string result = await BookService.ReturnBookAsync(returnBookInput);

        if (result == "Success")
        {
            ShowMessage("Book returned successfully!", false);
            returnBookInput = "";
            await LoadTransactions();
        }
        else
        {
            ShowMessage(result, true);
        }
    }

    private async Task QuickReturn(int bookId)
    {
        await BookService.ReturnBookAsync(bookId.ToString());
        ShowMessage("Book returned via Quick Action.", false);
        await LoadTransactions();
    }

    private void ShowMessage(string msg, bool isError)
    {
        Message = msg;
        IsError = isError;
    }
}

<style>
    /* ... (Your existing CSS code here - I have not touched it) ... */
    :root {
        --primary: #007bff;
        --success: #28a745;
        --sidebar-bg: #ffffff;
        --main-bg: #f4f7fa;
        --text-dark: #333;
        --text-light: #888;
        --border-color: #eee;
        --radius: 12px;
    }

    * {
        box-sizing: border-box;
        font-family: 'Segoe UI', sans-serif;
    }

    body {
        margin: 0;
        background-color: var(--main-bg);
        color: var(--text-dark);
    }

    .dashboard-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        min-height: 100vh;
    }

    .sidebar {
        background: var(--sidebar-bg);
        padding: 20px;
        border-right: 1px solid #eee;
        display: flex;
        flex-direction: column;
        gap: 20px;
        height: 100vh;
        position: sticky;
        top: 0;
    }

    .sidebar-header h3 {
        margin: 0;
        color: var(--primary);
        font-size: 1.2rem;
    }

    .search-box-sidebar {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-light);
    }

        .search-box-sidebar input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
        }

    .nav-label {
        font-size: 0.8rem;
        color: #aaa;
        margin-bottom: 5px;
        margin-top: 15px;
        font-weight: 600;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 15px;
        text-decoration: none;
        color: #555;
        border-radius: 8px;
        transition: 0.2s;
        margin-bottom: 5px;
        cursor: pointer;
    }

        .nav-item:hover {
            background: #eef2ff;
            color: var(--primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

    .main-content {
        padding: 25px 35px;
        overflow-y: auto;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .section-title {
        margin: 30px 0 15px 0;
        font-size: 1.1rem;
        color: #555;
    }

    .btn-outline {
        background: white;
        border: 1px solid #ddd;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        position: relative;
    }

    .badge-dot {
        width: 8px;
        height: 8px;
        background: red;
        border-radius: 50%;
        position: absolute;
        top: 8px;
        right: 8px;
    }

    .action-card {
        background: white;
        border-radius: var(--radius);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .tabs-header {
        display: flex;
        border-bottom: 1px solid #eee;
        background: #fafafa;
    }

    .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-weight: 600;
        color: #666;
        font-size: 1rem;
        border-bottom: 3px solid transparent;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

        .tab-btn:hover {
            background: #f0f0f0;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

    .tab-content {
        padding: 30px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr auto;
        gap: 20px;
        align-items: end;
    }

    .return-mode {
        grid-template-columns: 1fr 1fr auto;
    }

    .input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

        .input-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
        }

    .input-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        padding: 10px 15px;
        border-radius: 8px;
    }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            background: white;
        }

        .input-wrapper input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            font-size: 0.95rem;
        }

    .date-input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f8f9fa;
        outline: none;
        font-family: inherit;
    }

    .big-btn {
        padding: 12px 25px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        height: 45px;
    }

    .btn-primary {
        background: var(--primary);
    }

    .btn-success {
        background: var(--success);
    }

    .full-width {
        grid-column: span 1;
    }

    .fine-box {
        background: #e3f2fd;
        color: #0d47a1;
        padding: 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        height: 45px;
    }

    .table-card {
        background: white;
        border-radius: var(--radius);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
        border: 1px solid #eee;
    }

    .styled-table {
        width: 100%;
        border-collapse: collapse;
    }

        .styled-table thead {
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .styled-table th {
            text-align: left;
            padding: 15px 20px;
            font-weight: 600;
            color: #666;
            font-size: 0.9rem;
        }

        .styled-table td {
            padding: 15px 20px;
            border-bottom: 1px solid #f9f9f9;
            vertical-align: middle;
            color: #333;
        }

    .trans-id {
        font-family: monospace;
        color: #888;
    }

    .book-title {
        font-weight: 600;
    }

    .member-mini {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .avatar-mini {
        width: 24px;
        height: 24px;
        border-radius: 50%;
    }

    .date {
        font-size: 0.9rem;
        color: #555;
    }

    .text-red {
        color: #dc3545;
        font-weight: bold;
    }

    .status-badge {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 700;
    }

    .blue {
        background: #eef2ff;
        color: var(--primary);
    }

    .green {
        background: #d4edda;
        color: #155724;
    }

    .red {
        background: #f8d7da;
        color: #721c24;
    }

    .icon-btn {
        border: none;
        background: transparent;
        color: #888;
        cursor: pointer;
        transition: 0.2s;
    }

        .icon-btn:hover {
            color: var(--primary);
            transform: scale(1.1);
        }
</style>